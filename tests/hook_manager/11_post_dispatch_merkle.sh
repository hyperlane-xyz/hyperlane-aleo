#/bin/sh
. "$(cd "$(dirname "$0")" && pwd)/../helpers.sh"
cd ./hook_manager

address=aleo1wwfh5e70v42fal3dxn5j58gny7ahpuypz4y5qav482vxecvg7yxqqr52n6
zero_address="[0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8]"
transact leo execute post_dispatch $address "{version:3u8,nonce:0u32,origin_domain:0u32,sender:${zero_address},destination_domain:0u32,recipient:${zero_address},body:[0u128,0u128,0u128,0u128,0u128,0u128,0u128,0u128]}" '[0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8,0u8]' '[{spender: aleo1wwfh5e70v42fal3dxn5j58gny7ahpuypz4y5qav482vxecvg7yxqqr52n6, amount: 0u64}, {spender: aleo1wwfh5e70v42fal3dxn5j58gny7ahpuypz4y5qav482vxecvg7yxqqr52n6, amount: 0u64},{spender: aleo1wwfh5e70v42fal3dxn5j58gny7ahpuypz4y5qav482vxecvg7yxqqr52n6, amount: 0u64},{spender: aleo1wwfh5e70v42fal3dxn5j58gny7ahpuypz4y5qav482vxecvg7yxqqr52n6, amount: 0u64}]' || exit 1

expected_state="{\n  parent: aleo1rhgdu77hgyqd3xjj8ucu3jj9r2krwz6mnzyd80gncr5fxcwlh5rsvzp9px,\n  root: [\n    171104569506820442878030956749176332585u128,\n    254345134296549098270656672009806929715u128\n  ],\n  tree: {\n    branch: [\n      [\n        103024504100637318215782836284911664815u128,\n        285285244630345618535627245455827320671u128\n      ],\n      [\n        200636014418684474793900124069647889069u128,\n        241087320001230136080519585693436229163u128\n      ],\n      [\n        93974531276030024843854739648391266740u128,\n        63871773629875849864439396521971482176u128\n      ],\n      [\n        66294067272630431583104841350689447201u128,\n        177756802695730322470865725932422475556u128\n      ],\n      [\n        17747458619593854979588589471465572325u128,\n        91154039873745303917061774773470934559u128\n      ],\n      [\n        41440521891025744745128838831940743182u128,\n        60894629520669430433793374864326529801u128\n      ],\n      [\n        59903522946444936989019680377850199176u128,\n        138372656349779401676123096700574490028u128\n      ],\n      [\n        3180262733561280138502805056821254143u128,\n        174708888174609290132996609679840034611u128\n      ],\n      [\n        48455171203811811641967620231072081816u128,\n        233066451124647651551022141310218850885u128\n      ],\n      [\n        334080689485914854275740245880500189902u128,\n        298184847794429370937316245747346618882u128\n      ],\n      [\n        282653557140816677488147447345498217721u128,\n        220339046210024952190566302967731665406u128\n      ],\n      [\n        145672768088204442335147548738764583416u128,\n        195359773238112912523174698163665391889u128\n      ],\n      [\n        21418297075731751014499913670238572596u128,\n        208490304233564026108050214927462029255u128\n      ],\n      [\n        281404733672930043025800266103516225473u128,\n        249742050973351594617409037165098847317u128\n      ],\n      [\n        289879148739902069907218623618383439708u128,\n        272153760179965878774948581978868862730u128\n      ],\n      [\n        293159551140992943817529578958841871322u128,\n        279338235662809517033392482105447374970u128\n      ],\n      [\n        322093384055859711002317835595919209255u128,\n        42000488150413793222910142038008516924u128\n      ],\n      [\n        122254499464535460357349615889605317601u128,\n        163409875357997099341612933566874181274u128\n      ],\n      [\n        59132542617709958082991564676137889114u128,\n        213307109849065044721731388145721391918u128\n      ],\n      [\n        81821347195604723027123097456320473780u128,\n        213231151757453664031032733501577239314u128\n      ],\n      [\n        336114429845119848727407931190249152198u128,\n        301360598096960973755532425519001651903u128\n      ],\n      [\n        320542506166910886628941017057425965556u128,\n        289604304606881051317113816162407361165u128\n      ],\n      [\n        270315001578019215236444169667452771418u128,\n        159359836010757059645879798671718049365u128\n      ],\n      [\n        222279943939488608983982977534856788045u128,\n        110191212380795297761298100413926971842u128\n      ],\n      [\n        133196525511722763539122868050171643853u128,\n        317818349342580659794271157815744496524u128\n      ],\n      [\n        155004929552231825612177418997554921226u128,\n        187928388822560161625857840976354543861u128\n      ],\n      [\n        133005247855215888074055167590444355000u128,\n        277185228623223348062409148812927309868u128\n      ],\n      [\n        297025694464961376815096585744545123459u128,\n        40897156374938635533147054173498873588u128\n      ],\n      [\n        6336040213458809633392154838101667430u128,\n        62367222880804479430297662353502398838u128\n      ],\n      [\n        202117996738898010692652600915964103224u128,\n        46042986625269866222220954975551057138u128\n      ],\n      [\n        85413120008009180910770793363078390675u128,\n        71567477878241302074513460496530530059u128\n      ],\n      [\n        297864792032486788802704391190316402820u128,\n        225086078672275754295496924647458870974u128\n      ]\n    ],\n    count: 1u32\n  },\n  nonce: 0u32\n}"
assert_mapping_value hook_manager.aleo merkle_tree_hooks $address "$expected_state" || exit 1

# check events
expected_event="{\n  id: [\n    103024504100637318215782836284911664815u128,\n    285285244630345618535627245455827320671u128\n  ],\n  index: 0u32\n}"
assert_mapping_value hook_manager.aleo inserted_into_tree_events "{hook:$address,index:0u32}" "$expected_event" || exit 1
